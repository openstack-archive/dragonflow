<!--
    #!/bin/bash

#    Licensed under the Apache License, Version 2.0 (the "License"); you may
#    not use this file except in compliance with the License. You may obtain
#    a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#    License for the specific language governing permissions and limitations
#    under the License.
#    Developed by Shlomo Narkolayev | shlominar@gmail.com
-->

<html>
    <head>
        <script src="jquery-2.2.4.js"></script>
        <style type="text/css">
            html, body {
                height: 100%;
            }

            html {
                display: table;
                margin: auto;
            }
            body {
                display: table-cell;
                vertical-align: middle;
            }

            table.tableClass {
	            font-family: verdana,arial,sans-serif;
	            font-size:11px;
	            color:#333333;
	            border-width: 1px;
	            border-color: #999999;
	            border-collapse: collapse;
                text-align:center;
            }
            table.tableClass th {
	            background:#B1E87D;
	            border-width: 1px;
	            padding: 8px;
	            border-style: solid;
	            border-color: #999999;
                text-align:center;
            }
            table.tableClass td {
	            background:#dcddc0 url('cell-grey.jpg');
	            border-width: 1px;
	            padding: 8px;
	            border-style: solid;
	            border-color: #999999;
                text-align:center;
            }
        </style>

        <script>
            function parseResults() {
                $.get("testResults.txt", function (data) {
                    processData(data);
                });
            }

            function processData(data) {
                eastWestJson = [ ];
                vmToFipJson = [ ];
                sNatJson = [ ];

                var allTextLines = data.split(/\r\n|\n/);
                var headers = allTextLines[0].split(',');

                for (var i = 0; i < allTextLines.length; i++) {
                    var data = allTextLines[i].split(',');
                    if (data[0] == "datetime") {
                        datetime = data[1];
                    }
                    else if (data[0] == "bandwidth") {

                        //Adding to the combo-box all packet sizes
                        if (!$("#combobox option[value='" + data[2] + "']").length) {
                            $('<option>').val(data[2]).text(data[2]).appendTo($('#combobox'));
                        }

                        //Adding to the resultsSummary array the bandwidth results
                        if (data[2] == "2048") {
                            resultsSummary.push(
                                { testType: data[0], scenario: data[1], layer: data[3].split("-")[0], node: data[3].split("-")[1], value: data[4] }
                            );
                        }

                        if (data[1] == "eastWest") {
                            //bandwidth, scenario, packet size, L2/3-Cross/SameNode, pktPerSec, bandwidth
                            //e.g. -> 
                            //bandwidth, eastWest, 2048, L2-CrossNode, 30569.92, 9024.75
                            if ($('#combobox').val() > 0 && $('#combobox').val() == data[2]) {
                                eastWestJson.push(
                                  { layer: data[3].split("-")[0], node: data[3].split("-")[1], bandwidth: data[4] }
                                );
                            }
                        }
                        else if (data[1] == "VM2FIP") {
                            if ($('#combobox').val() > 0 && $('#combobox').val() == data[2]) {
                                vmToFipJson.push(
                                  { bandwidth: data[4] }
                                );
                            }
                        }
                        else if (data[1] == "sNAT") {
                            if ($('#combobox').val() > 0 && $('#combobox').val() == data[2]) {
                                sNatJson.push(
                                  { bandwidth: data[4] }
                                );
                            }
                        }
                    }
                    else if (data[0] != "bandwidth") { //Adding to the resultsSummary array all the of results
                        resultsSummary.push(
                                { testType: data[0], scenario: data[1], layer: data[2], node: data[3], value: data[4] }
                            );
                    }
                    //debugger;
                }
                updateBandwidthTables();
            }

            var eastWestJson = [ ];
            var vmToFipJson = [ ];
            var sNatJson = [ ];
            var resultsSummary = [ ];

            var loadOnceFlag = true;

            var datetime;

            parseResults();
        </script>
    </head>

    <body>
        <p style="text-align:right;"><span id="datetime_span"></span></p>
        <p><b>Welcome to DragonFlow data plane performance test results</b></p>
        <br />

        <p><b>Overall test results</b></p>
        <table id="resultsSummary" class="tableClass">
            <tr>
                <th>Test type</th>
                <th colspan="2">L2</th>
                <th colspan="2">L3</th>
                <th>VM to FIP</th>
                <th>SNAT</th>
            </tr>
            <tr style="font-weight:bold;">
                <td></td>
                <td>Cross</td>
                <td>Same</td>
                <td>Cross</td>
                <td>Same</td>
                <td></td>
                <td></td>
            </tr>
        </table>
        <br />
        <hr />
        <p><b>Bandwidth test results</b></p>
        <p>Choose packet size: <select id="combobox" onChange="parseResults();"></select> Bytes</p>
        <p><b>East-west</b></p>
        <table id="bandwidth" class="tableClass">
            <tr>
                <th>Network Layer</th>
                <th>Cross/Same Node</th>
                <th>Bandwidth (mbps)</th>
            </tr>
        </table>

        <br />
        <table>
            <tr>
                <th>
                    <p>VM to FIP</p>
                    <table id="vmToFIP" class="tableClass">
                        <tr>
                            <th>Bandwidth (mbps)</th>
                        </tr>
                    </table>
                </th>
                <th style="width:70px;">
                </th>
                <th>
                    <p>Source NAT</p>
                    <table id="sNAT" class="tableClass">
                        <tr>
                            <th>Bandwidth (mbps)</th>
                        </tr>
                    </table>
                </th>
            </tr>
        </table>

        <script>
            function updateBandwidthTables() {
                //Bandwidth results

                //East-west
                $('#bandwidth tr:gt(0)').remove();
                var tr;
                for (var i = 0; i < eastWestJson.length; i++) {
                    tr = $('<tr/>');
                    tr.append("<td>" + eastWestJson[i].layer + "</td>");
                    tr.append("<td>" + eastWestJson[i].node + "</td>");
                    tr.append("<td style=\"background-color:F3F3E4; font-weight:bold;\">" + eastWestJson[i].bandwidth + "</td>");
                    $('#bandwidth').append(tr);
                }

                //VM to FIP
                $('#vmToFIP tr:gt(0)').remove();
                var tr;
                for (var i = 0; i < vmToFipJson.length; i++) {
                    tr = $('<tr/>');
                    tr.append("<td style=\"background-color:F3F3E4; font-weight:bold;\">" + vmToFipJson[i].bandwidth + "</td>");
                    $('#vmToFIP').append(tr);
                }

                //SNAT
                $('#sNAT tr:gt(0)').remove();
                var tr;
                for (var i = 0; i < sNatJson.length; i++) {
                    tr = $('<tr/>');
                    tr.append("<td style=\"background-color:F3F3E4; font-weight:bold;\">" + sNatJson[i].bandwidth + "</td>");
                    $('#sNAT').append(tr);
                }
            }
            updateBandwidthTables();
            //Test results summary
            window.setTimeout(function () {
                if (loadOnceFlag)
                {
                    document.getElementById("datetime_span").textContent = datetime;
                    loadOnceFlag = false; //preventing updating table's content on page refresh

                    //Creating a matrix that will contain the results summary
                    var trs = new Array(4);
                    for (var i = 0; i < 4; i++)
                        trs[i] = new Array(7);

                    //Rotating the origin results matrix and storing in the "trs" matrix
                    for (var i = 0; i < resultsSummary.length; i++) {
                        if (resultsSummary[i].testType == "bandwidth") {
                            j = 0;
                            trs[j][0] = "Bandwidth (mbps)";
                        }
                        else if (resultsSummary[i].testType == "packetsPerSecond") {
                            j = 1;
                            trs[j][0] = "Packets/second";
                        }
                        else if (resultsSummary[i].testType == "latency") {
                            j = 2;
                            trs[j][0] = "Latency (ms)";
                        }
                        else if (resultsSummary[i].testType == "jitter") {
                            j = 3;
                            trs[j][0] = "Jitter (ms)";
                        }

                        if (resultsSummary[i].scenario == "eastWest") {
                            if (resultsSummary[i].layer == "L2") {
                                if (resultsSummary[i].node == "SameNode") 
                                    trs[j][1] = parseFloat(resultsSummary[i].value).toLocaleString();
                                else //cross
                                    trs[j][2] = parseFloat(resultsSummary[i].value).toLocaleString();
                            }
                            else { //L3
                                if (resultsSummary[i].node == "SameNode")
                                    trs[j][3] = parseFloat(resultsSummary[i].value).toLocaleString();
                                else //cross
                                    trs[j][4] = parseFloat(resultsSummary[i].value).toLocaleString();
                            }
                        }
                        else if (resultsSummary[i].scenario == "sNAT") 
                            trs[j][5] = parseFloat(resultsSummary[i].value).toLocaleString();
                        else if (resultsSummary[i].scenario == "VM2FIP") 
                            trs[j][6] = parseFloat(resultsSummary[i].value).toLocaleString();
                    }

                    //updating the html table with the rotated matrix
                    var tr;
                    for (var i = 0; i < 4; i++) {
                        tr = $('<tr/>');
                        for (var j = 0; j < 7; j++)
                            tr.append("<td>" + trs[i][j] + "</td>");
                        $('#resultsSummary').append(tr);
                    }
                }
            }, 50);
        </script>
    </body>
</html>